DEG2RAD = Math::PI / 180.0
RAD2DEG = 180.0 / Math::PI

# КЛАССИЧЕСКИЙ вариант (совпадает с комментарием в твоём коде):
# Порядок поворотов: X → Y → Z (intrinsic), матрица: R = Rz(z) * Ry(y) * Rx(x)
# Для этого варианта верно: y = asin(-r20)
def euler_xyz_to_matrix_rowmajor_standard(val)
  x, y, z = val.map { |v| v * DEG2RAD }
  sx = Math.sin(x)
  cx = Math.cos(x)
  sy = Math.sin(y)
  cy = Math.cos(y)
  sz = Math.sin(z)
  cz = Math.cos(z)

  r00 =  cz * cy
  r01 =  (cz * sy * sx) - (sz * cx)
  r02 =  (cz * sy * cx) + (sz * sx)

  r10 =  sz * cy
  r11 =  (sz * sy * sx) + (cz * cx)
  r12 =  (sz * sy * cx) - (cz * sx)

  r20 = -sy
  r21 =  cy * sx
  r22 =  cy * cx

  [
    [r00, r01, r02],
    [r10, r11, r12],
    [r20, r21, r22]
  ]
end

def matrix_rowmajor_to_euler_xyz_standard(m)
  # Берём элементы исходной row-major матрицы
  m00, m01, m02 = m[0]
  m10, m11, m12 = m[1]
  m20, m21, m22 = m[2]

  # Явно переходим к "игровой" конвенции: используем транспонированную матрицу
  r00 = m00
  r01 = m10
  r02 = m20
  r10 = m01
  r11 = m11
  r12 = m21
  r20 = m02
  r21 = m12
  r22 = m22

  # Классическая XYZ (intrinsic): R = Rz(z) * Ry(y) * Rx(x)
  # y = asin(-r20), см. ваш коммент и прямую функцию
  if r20.abs < 0.999999
    y = Math.asin(-r20)
    x = Math.atan2(r21, r22)
    z = Math.atan2(r10, r00)
  else
    # Gimbal lock
    y = Math.asin(-r20)
    x = Math.atan2(-r12, r11)
    z = 0.0
  end

  [x, y, z].map { |v| v * RAD2DEG }
end

# val = [0.000000, 0.000000, -2.489553]
# res = euler_xyz_to_matrix_rowmajor_standard(val)
values = [
  { name: 'joint1', values: [-0.0, 90.0, 0.0],
    ref: [[-4.371138828673793e-08, 0.0, 1.0], [0.0, 1.0, 0.0], [-1.0, 0.0, -4.371138828673793e-08]] },
  { name: 'joint2', values: [0.0, -0.0, -2.489552894184988],
    ref: [[0.9990561604499817, 0.04343722388148308, 0.0], [-0.04343722388148308, 0.9990561604499817, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint3', values: [179.9999950025647, -3.3952856324503467e-07, -3.8867343706792417],
    ref: [[0.9976999759674072, -0.06778429448604584, 0.0], [-0.06778429448604584, -0.9976999759674072, -8.742277657347586e-08], [5.925891333191657e-09, 8.722170008468311e-08, -1.0]] },
  { name: 'joint4', values: [-179.9999949973089, 2.5044761317104194e-07, -2.865981741148593],
    ref: [[0.9987491965293884, -0.04999995976686478, 0.0], [-0.04999995976686478, -0.9987491965293884, 8.742277657347586e-08], [-4.371135453595798e-09, -8.731343115186974e-08, -1.0]] },
  { name: 'joint5', values: [179.99999663544722, -3.7107178299843045e-06, -47.80102189223833],
    ref: [[0.6717073917388916, -0.740816593170166, 0.0], [-0.740816593170166, -0.6717073917388916, -8.742277657347586e-08], [6.476424374568523e-08, 5.8722523732512855e-08, -1.0]] },
  { name: 'joint6', values: [0.0, -0.0, -45.87037678018662],
    ref: [[0.6962839961051941, 0.7177664041519165, 0.0], [-0.7177664041519165, 0.6962839961051941, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint7', values: [179.9999949993188, -2.8779579812909505e-07, -3.293814332662125],
    ref: [[0.9983479976654053, -0.05745624378323555, 4.930380657631324e-32], [-0.05745624378323555, -0.9983479976654053, -8.742277657347586e-08], [5.022984250757645e-09, 8.727835165700526e-08, -1.0]] },
  { name: 'joint8', values: [0.0, -0.0, -8.589947596270317],
    ref: [[0.9887825846672058, 0.14936186373233795, 0.0], [-0.14936186373233795, 0.9887825846672058, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint9', values: [-179.99999568711127, 2.5472798839469313e-06, -30.566963659240535],
    ref: [[0.8610354065895081, -0.5085450410842896, 0.0], [-0.5085450410842896, -0.8610354065895081, 8.742277657347586e-08], [-4.445842094469299e-08, -7.527410872398832e-08, -1.0]] },
  { name: 'joint10', values: [179.99999499965548, -2.9359252442490573e-07, -3.36023298003687],
    ref: [[0.9982807636260986, -0.05861351639032364, 0.0], [-0.05861351639032364, -0.9982807636260986, -8.742277657347586e-08], [5.124156210456476e-09, 8.727247546858052e-08, -1.0]] },
  { name: 'joint12', values: [-90.00000217528196, 9.681165208035488, 31.10880417467309],
    ref: [[0.8439945578575134, -0.14398108422756195, -0.5166649222373962], [0.5093069672584534, -0.08688516914844513, 0.8561877012252808], [-0.16816534101963043, -0.9857587814331055, -3.7425152754622104e-08]] },
  { name: 'joint13', values: [0.0, -0.0, -11.45498502058948],
    ref: [[0.9800810217857361, 0.1985979825258255, 0.0], [-0.1985979825258255, 0.9800810217857361, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint15', values: [-179.99999670368229, 3.771462862179015e-06, -138.84603235771618],
    ref: [[-0.7529438734054565, -0.6580847501754761, 8.742277657347586e-08], [-0.6580847501754761, 0.7529438734054565, 1.22514845490862e-16], [-6.582444456171288e-08, -5.7531597263960066e-08, -1.0]] },
  { name: 'joint16', values: [-179.99999499787762, 2.6156021678370094e-07, -2.9932614172437075],
    ref: [[0.9986357092857361, -0.05221850797533989, -1.232595164407831e-32], [-0.05221850797533989, -0.9986357092857361, 8.742277657347586e-08], [-4.565086975105714e-09, -8.730350486985117e-08, -1.0]] },
  { name: 'joint17', values: [0.0, -0.0, -9.645220241781617],
    ref: [[0.9858641028404236, 0.16754688322544098, 0.0], [-0.16754688322544098, 0.9858641028404236, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint18', values: [179.9999957757149, -2.6916644460443993e-06, -32.504805231383834],
    ref: [[0.843346357345581, -0.5373703241348267, 0.0], [-0.5373703241348267, -0.843346357345581, -8.742277657347586e-08], [4.697840694234401e-08, 7.372768351388004e-08, -1.0]] },
  { name: 'joint19', values: [-179.99999502097467, 5.467621326256565e-07, -6.266716902151176],
    ref: [[0.9940245151519775, -0.10915689915418625, 0.0], [-0.10915689915418625, -0.9940245151519775, 8.742277657347586e-08], [-9.542799439543614e-09, -8.690038555414503e-08, -1.0]] },
  { name: 'joint21', values: [90.00000219753615, -10.124672478902971, 30.25643766295432],
    ref: [[0.850327730178833, -0.15184424817562103, 0.5038710236549377], [0.4960245192050934, -0.08857585489749908, -0.8637788891792297], [0.17579065263271332, 0.9844275712966919, -3.775697265950839e-08]] },
  { name: 'joint22', values: [0.0, -0.0, -17.94842057317833],
    ref: [[0.9513342976570129, 0.3081606924533844, 0.0], [-0.3081606924533844, 0.9513342976570129, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint24', values: [-179.99999663192693, 3.707522822862368e-06, -47.74664134959628],
    ref: [[0.6724101901054382, -0.7401787042617798, 0.0], [-0.7401787042617798, -0.6724101901054382, 8.742277657347586e-08], [-6.470848035178278e-08, -5.878396436287403e-08, -1.0]] },
  { name: 'joint25', values: [0.0, -0.0, -66.69978178176437],
    ref: [[0.3955489993095398, 0.9184448719024658, 0.0], [-0.9184448719024658, 0.3955489993095398, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'bein_l', values: [0.0, -0.0, -176.78193398249525],
    ref: [[-0.9984230995178223, 0.056136321276426315, 0.0], [-0.056136321276426315, -0.9984230995178223, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint28', values: [0.0, -0.0, -4.307202978587402],
    ref: [[0.9971756935119629, 0.07510408759117126, 0.0], [-0.07510408759117126, 0.9971756935119629, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint29', values: [-179.99999502627648, 5.930572687915414e-07, -6.799734911932454],
    ref: [[0.9929660558700562, -0.11839937418699265, 0.0], [-0.11839937418699265, -0.9929660558700562, 8.742277657347586e-08], [-1.035080199329741e-08, -8.6807851573667e-08, -1.0]] },
  { name: 'joint30', values: [0.0, -0.0, -70.25316726817981],
    ref: [[0.3378646969795227, 0.9411947131156921, 0.0], [-0.9411947131156921, 0.3378646969795227, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'bein_r', values: [-179.99999976479597, 5.003430820493824e-06, -177.30858997511015],
    ref: [[-0.9988968968391418, -0.04695669189095497, 8.742277657347586e-08], [-0.04695669189095497, 0.9988968968391418, -1.22514845490862e-16], [-8.73263417133785e-08, -4.1050847165990945e-09, -1.0]] },
  { name: 'joint33', values: [0.0, -0.0, -2.4815364987373587],
    ref: [[0.9990622401237488, 0.04329744353890419, 0.0], [-0.04329744353890419, 0.9990622401237488, 0.0], [0.0, 0.0, 1.0]] },
  { name: 'joint34', values: [-89.96917069466882, -0.005037254931095262, -81.44086902486713],
    ref: [[0.14883001148700714, 0.0005451648612506688, 0.9888626337051392], [-0.9888626933097839, -6.8559656938305125e-06, 0.14883004128932953], [8.791668369667605e-05, -0.9999998211860657, 0.0005380728398449719]] },
  { name: 'joint35', values: [-0.20714307205007657, 6.627045479077578e-09, -8.559185008090157],
    ref: [[0.9888626933097839, 0.14882999658584595, 0.0005380717921070755], [-0.14883096516132355, 0.9888561964035034, 0.0035750558599829674], [-1.1566376328930872e-10, -0.0036153208930045366, 0.9999935030937195]] }
]

game_values = [
  { name: 'joint1', ref: [[-4.371138828673793e-08, 0.0, -1.0], [0.0, 1.0, 0.0], [1.0, 0.0, -4.371138828673793e-08]] },
  { name: 'joint2',
    ref: [[0.9990561604499817, -0.043437227606773376, 0.0], [0.043437227606773376, 0.9990561604499817, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint3',
    ref: [[0.9976999759674072, -0.06778429448604584, 0.0],
          [-0.06778429448604584, -0.9976999759674072, -8.742277657347586e-08], [5.925891333191657e-09, 8.722170008468311e-08, -1.0]] },
  { name: 'joint4',
    ref: [[0.9987491965293884, -0.04999997094273567, 0.0],
          [-0.04999997094273567, -0.9987491965293884, 8.742277657347586e-08], [-4.371136341774218e-09, -8.731343115186974e-08, -1.0]] },
  { name: 'joint5',
    ref: [[0.6717073917388916, -0.740816593170166, 6.981316857945785e-08],
          [-0.740816593170166, -0.6717073917388916, -8.742277657347586e-08], [1.1165826663273037e-07, 7.003770008395804e-09, -1.0]] },
  { name: 'joint6',
    ref: [[0.6962839365005493, -0.7177664041519165, 0.0], [0.7177664041519165, 0.6962839365005493, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint7',
    ref: [[0.9983479976654053, -0.05745624005794525, 0.0],
          [-0.05745624005794525, -0.9983479976654053, -8.742277657347586e-08], [5.022984250757645e-09, 8.727835165700526e-08, -1.0]] },
  { name: 'joint8',
    ref: [[0.9887825846672058, -0.14936186373233795, 0.0], [0.14936186373233795, 0.9887825846672058, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint9',
    ref: [[0.8610354065895081, -0.5085449814796448, -5.2359883540020746e-08],
          [-0.5085449814796448, -0.8610354065895081, 8.742277657347586e-08], [-8.954212660228222e-08, -4.8646754180481366e-08, -1.0]] },
  { name: 'joint10',
    ref: [[0.9982807636260986, -0.05861352011561394, 0.0],
          [-0.05861352011561394, -0.9982807636260986, -8.742277657347586e-08], [5.124156654545686e-09, 8.727247546858052e-08, -1.0]] },
  { name: 'joint12',
    ref: [[0.8439945578575134, 0.5093069076538086, -0.16816532611846924],
          [-0.14398105442523956, -0.08688515424728394, -0.9857587814331055], [-0.5166648626327515, 0.8561877012252808, -4.3088885348652184e-08]] },
  { name: 'joint13',
    ref: [[0.9800810217857361, -0.1985979825258255, 0.0], [0.1985979825258255, 0.9800810217857361, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint15',
    ref: [[-0.7529439330101013, -0.6580846309661865, -6.981316857945785e-08],
          [-0.6580846309661865, 0.7529439330101013, 8.742277657347586e-08], [-4.966185684907032e-09, 1.1176742020779784e-07, -1.0]] },
  { name: 'joint16',
    ref: [[0.9986357092857361, -0.05221850425004959, 0.0],
          [-0.05221850425004959, -0.9986357092857361, 8.742277657347586e-08], [-4.5650865310165045e-09, -8.730350486985117e-08, -1.0]] },
  { name: 'joint17',
    ref: [[0.9858641028404236, -0.16754688322544098, 0.0], [0.16754688322544098, 0.9858641028404236, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint18',
    ref: [[0.843346357345581, -0.5373703837394714, 5.2359883540020746e-08],
          [-0.5373703837394714, -0.843346357345581, -8.742277657347586e-08], [9.113593080201099e-08, 4.5591033170921946e-08, -1.0]] },
  { name: 'joint19',
    ref: [[0.9940245151519775, -0.10915690660476685, -1.7453292144864463e-08],
          [-0.10915690660476685, -0.9940245151519775, 8.742277657347586e-08], [-2.689180078618847e-08, -8.49952357384609e-08, -1.0]] },
  { name: 'joint21',
    ref: [[0.850327730178833, 0.49602457880973816, 0.17579063773155212],
          [-0.15184423327445984, -0.08857585489749908, 0.9844275712966919], [0.5038710832595825, -0.8637788891792297, -4.303069545130711e-08]] },
  { name: 'joint22',
    ref: [[0.9513342976570129, -0.3081607222557068, 0.0], [0.3081607222557068, 0.9513342976570129, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint24',
    ref: [[0.672410249710083, -0.7401787042617798, -6.981316857945785e-08],
          [-0.7401787042617798, -0.672410249710083, 8.742277657347586e-08], [-1.1165157332015951e-07, -7.109751010148102e-09, -1.0]] },
  { name: 'joint25',
    ref: [[0.3955489993095398, -0.9184448719024658, 0.0], [0.9184448719024658, 0.3955489993095398, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'bein_l',
    ref: [[-0.9984230995178223, -0.056136321276426315, 0.0], [0.056136321276426315, -0.9984230995178223, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint28',
    ref: [[0.9971756935119629, -0.07510408759117126, 0.0], [0.07510408759117126, 0.9971756935119629, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint29',
    ref: [[0.9929660558700562, -0.11839937418699265, -1.7453292144864463e-08],
          [-0.11839937418699265, -0.9929660558700562, 8.742277657347586e-08], [-2.7681327452455662e-08, -8.474139434611061e-08, -1.0]] },
  { name: 'joint30',
    ref: [[0.3378646969795227, -0.9411947131156921, 0.0], [0.9411947131156921, 0.3378646969795227, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'bein_r',
    ref: [[-0.9988969564437866, -0.046956583857536316, -8.726646427703599e-08],
          [-0.046956583857536316, 0.9988969564437866, 8.742277657347586e-08], [8.306513166189688e-08, 9.142408430307114e-08, -1.0]] },
  { name: 'joint33',
    ref: [[0.9990622401237488, -0.04329743608832359, 0.0], [0.04329743608832359, 0.9990622401237488, 0.0],
          [0.0, 0.0, 1.0]] },
  { name: 'joint34',
    ref: [[0.14882993698120117, -0.9888628125190735, 8.791223808657378e-05],
          [0.0005451584584079683, -6.8526569521054626e-06, -0.9999998807907104], [0.9888626933097839, 0.14882996678352356, 0.0005380670190788805]] },
  { name: 'joint35',
    ref: [[0.9888626337051392, -0.14883096516132355, 0.0],
          [0.14882999658584595, 0.9888561367988586, -0.0036153194960206747], [0.0005380715010687709, 0.0035750544629991055, 0.9999934434890747]] }
]

values.each_with_index do |val, index|
  a = matrix_rowmajor_to_euler_xyz_standard(val[:ref])
  res = euler_xyz_to_matrix_rowmajor_standard(a)
  puts val[:name]
  puts val[:ref].reduce('') { |acc, v| acc + "#{v}\n" }
  puts '** MY RESULT:'
  puts res.reduce('') { |acc, v| acc + "#{v}\n" }
  puts '** GAME RESULT:'
  puts game_values[index][:ref].reduce('') { |acc, v| acc + "#{v}\n" }
  puts '_________'
  puts
  puts
end
